---
title: "km_survival_lgg.Rmd"
author: "Run Jin"
date: "8/11/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Kaplan-Meier Example

The [Kaplan-Meier](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3059453/) 
survival curve shows the probability of survival over time.

```{r Kaplan Meier}
kap_fit <- survival_analysis(metadata,
  ind_var = "germline_sex_estimate",
  test = "kap.meier",
  metadata_sample_col = "Kids_First_Biospecimen_ID",
  ind_data_sample_col = "sample"
)
```

`survminer` package comes with a convenient plotting function which uses `ggplot2`
arguments. 
It requires the original Kaplain-Meier `survfit` object, so we will extract that with `$model`.

```{r Make survival plot}
surv_plot <- survminer::ggsurvplot(kap_fit$model,
  pval = TRUE,
  data = kap_fit$original_data,
  risk.table = TRUE,
  xlim = c(0, 2000),
  break.time.by = 500,
  ggtheme = theme_minimal(),
  risk.table.y.text.col = TRUE,
  risk.table.y.text = FALSE
)
# Make this plot a combined plot
surv_plot <- cowplot::plot_grid(surv_plot[[1]], surv_plot[[2]], nrow = 2, 
                                rel_heights = c(2.5, 1))
# Print it out here
surv_plot
```

Save the plot to a file. 

```{r Save survival plot}
# We can save the plot like a normal ggplot
cowplot::save_plot(filename = kap_meier_plot_file, plot = surv_plot)
```

## Log-Rank Example

For testing whether two survival curves are different, we can use Log-Rank which
can be implemented using `survival::survdiff` function. 
In this example, we will test for survival curve differences between for 
`germline_sex_estimate` categories. 
Use the `survdiff` function to test the differences between the `Male` and `Female` 
curves.

```{r Do log rank test}
logrank_fit <- survival_analysis(metadata,
  ind_var = "germline_sex_estimate",
  test = "log.rank",
  metadata_sample_col = "Kids_First_Biospecimen_ID",
  ind_data_sample_col = "sample"
)
```

Print table of the results.

```{r Make log rank table}
# Print out the table here
logrank_fit$table %>%
  dplyr::mutate(p.value = logrank_fit$model$p.value) %>%
  knitr::kable(digits = 2)
```

```{r Write log rank to table}
# Save the table data in a TSV
readr::write_tsv(logrank_fit$table, logrank_table_file)