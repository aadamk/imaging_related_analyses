---
title: "TPM Plots of LGG, HGG and Medulloblastoma Samples per Harmonized Diagnosis"
author: "Run Jin"
date: "8/11/2021"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(car)
library(multcomp)
library(kableExtra)
```

## Import Relevant Data
```{r import data}
histology_df <- read_tsv("../data/histologies.tsv")
expression_data <- readRDS("../data/gene-expression-rsem-tpm-collapsed.rds")
```

Define directory
```{r define directory}
# create directory 
root_dir <- rprojroot::find_root(rprojroot::has_dir(".git"))

stats_anova_dir <- file.path(root_dir, "molecular_target_radiation", "stats", "anova")
stats_tukey_dir <- file.path(root_dir, "molecular_target_radiation", "stats", "tukey")

tpm_plots_dir <- file.path(root_dir, "molecular_target_radiation", "plots", "TPM_violin")

if (!dir.exists(stats_anova_dir )) {
  dir.create(stats_anova_dir , recursive = TRUE)
}

if (!dir.exists(stats_tukey_dir )) {
  dir.create(stats_tukey_dir , recursive = TRUE)
}

if (!dir.exists(tpm_plots_dir )) {
  dir.create(tpm_plots_dir , recursive = TRUE)
}
```

## Select cohort of interest and relevant clincial info 
```{r cohort selection}
cohort_df <- histology_df %>% dplyr::filter(tumor_descriptor == "Initial CNS Tumor") %>%
  dplyr::filter(experimental_strategy=="RNA-Seq") %>% 
  dplyr::filter(cancer_group %in% c("LGG", "Low-grade glioma/astrocytoma", "High-grade glioma/astrocytoma", "Medulloblastoma")) %>%
  dplyr::select(Kids_First_Biospecimen_ID, harmonized_diagnosis)

nrow(cohort_df)
cohort_df
```

## Subset gene expression data to cohort of interest and genes of interest
```{r}
cohort_bsid <- cohort_df %>% pull(Kids_First_Biospecimen_ID) %>% unique()
expression_of_interest <- expression_data %>% dplyr::select(all_of(cohort_bsid)) %>% 
  rownames_to_column("GeneSymbol") %>% 
  dplyr::filter(GeneSymbol %in% c("SLC7A5", "FOLH1")) %>% 
  column_to_rownames("GeneSymbol") %>%
  t() %>% as.data.frame() %>%
  rownames_to_column("Kids_First_Biospecimen_ID")

#annotate relevant clinical information to the expression data frame
combined <- expression_of_interest %>% dplyr::left_join(cohort_df) 
```

## Generate violin plot per harmonized_diagnosis
First for SLC7A5
```{r}
n_sample_hd <- combined %>% group_by(harmonized_diagnosis) %>% summarize(n=n())
p<-combined %>%
  dplyr::left_join(n_sample_hd) %>%
  dplyr::mutate(myaxis = paste0(harmonized_diagnosis, "\n", "n=", n)) %>%
  ggplot( aes(x=myaxis, y=SLC7A5, fill=harmonized_diagnosis)) +
    geom_violin(width=1.4, trim=FALSE, show.legend = F) +
    geom_boxplot(width=0.1, color="black", show.legend = F) +
    labs(title="SLC7A5 TPM per Harmonized Diagnosis",x="Harmonized Diagnosis", y = "SLC7A5 TPM Value") + 
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print(p)
ggsave(file.path(tpm_plots_dir, "slc7a5_harmonized_diagnosis_violin.png"), p)
```

And then for FOLH1
```{r}
p<-combined %>%
  dplyr::left_join(n_sample_hd) %>%
  dplyr::mutate(myaxis = paste0(harmonized_diagnosis, "\n", "n=", n)) %>%
  ggplot( aes(x=myaxis, y=FOLH1, fill=harmonized_diagnosis)) +
    geom_violin(width=1.4, trim=FALSE, show.legend = F) +
    geom_boxplot(width=0.1, color="black", show.legend = F) +
    labs(title="FOLH1 TPM per Harmonized Diagnosis",x="Harmonized Diagnosis", y = "FOLH1 TPM Value") + 
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
print(p)
ggsave(file.path(tpm_plots_dir, "folh1_harmonized_diagnosis_violin.png"),p)
```

## Calculate ANOVA+Tukey's PostHoc per harmonized_diagnosis

First for SLC7A5
```{r}
res_aov <- aov(combined$SLC7A5 ~ combined$harmonized_diagnosis,
  data = combined)

# testing the normality of the data using histology
hist(res_aov$residuals)
```

```{r}
# testing the normality of the data using qqplot
qqPlot(res_aov$residuals,
  id = FALSE # id = FALSE to remove point identification
)
```

Showing the summary of statistics
```{r}
summary(res_aov)
anova_result <- summary(res_aov)[[1]] %>% rownames_to_column()
write_tsv(anova_result, file.path(stats_anova_dir, "anova_result_slc7A5_hd.tsv"))
```

Performing Tukey's Post Hoc analysis
```{r}
tukey.test<-TukeyHSD(res_aov)[1] %>% as.data.frame() %>% rownames_to_column() 
colnames(tukey.test) <- c("Pair Compared", "DIFF", "LWR", "UPR", "P.adj")

tukey.test <- tukey.test %>% arrange(P.adj, descending = TRUE)

tukey.test %>%
  kbl(caption = "Turkey results for SLC7A5 for each harmonized diagnosis") %>%
  kable_classic(full_width = F, html_font = "Cambria")

write_tsv(tukey.test, file.path(stats_tukey_dir, "tukey_result_slc7A5_hd.tsv"))
```
Plotting the 95% interval
```{r}
plot(TukeyHSD(res_aov), las=1, cex.axis=0.4)
```


Next for FOLH1
```{r}
res_aov <- aov(combined$FOLH1 ~ combined$harmonized_diagnosis,
  data = combined)

# testing the normality of the data using histology
hist(res_aov$residuals)
```

```{r}
# testing the normality of the data using qqplot
qqPlot(res_aov$residuals,
  id = FALSE # id = FALSE to remove point identification
)
```

Showing the summary of statistics
```{r}
summary(res_aov)
anova_result <- summary(res_aov)[[1]] %>% rownames_to_column()
write_tsv(anova_result, file.path(stats_anova_dir, "anova_result_folh1_hd.tsv"))
```

Performing Tukey's Post Hoc analysis
```{r}
tukey.test<-TukeyHSD(res_aov)[1] %>% as.data.frame() %>% rownames_to_column()
colnames(tukey.test) <- c("Pair Compared", "DIFF", "LWR", "UPR", "P.adj")

tukey.test <- tukey.test %>% arrange(P.adj, descending = TRUE)
tukey.test %>%
  kbl(caption = "Turkey results for FOLH1 for each harmonized diagnosis") %>%
  kable_classic(full_width = F, html_font = "Cambria")
write_tsv(tukey.test, file.path(stats_tukey_dir, "tukey_result_folh1_hd.tsv"))
```
Plotting the 95% interval
```{r}
plot(TukeyHSD(res_aov), las=1, cex.axis=0.4)
```
